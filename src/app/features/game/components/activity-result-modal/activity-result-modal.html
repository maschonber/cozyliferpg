<div class="activity-result-modal">
  <h2 mat-dialog-title>
    <mat-icon>{{ activityIcon }}</mat-icon>
    {{ data.summary.activity.name }}
    @if (isSocialActivity && data.summary.npc) {
      <span class="npc-context">with {{ data.summary.npc.name }}</span>
    }
  </h2>

  <mat-dialog-content>
    <div class="result-content">
      <!-- Outcome Section (for activities with rolls) -->
      @if (hasOutcome) {
        @let outcome = data.summary.outcome!;
        @let tierInfo = getTierInfo(outcome.tier);

        <div class="outcome-section" [style.--tier-color]="tierInfo.color">
          <div class="tier-badge">
            <mat-icon [style.color]="tierInfo.color">{{ tierInfo.icon }}</mat-icon>
            <span class="tier-label">{{ tierInfo.label }}</span>
            @if (isCritSuccess) {
              <span class="crit-indicator crit-success">CRITICAL SUCCESS!</span>
            }
            @if (isCritFail) {
              <span class="crit-indicator crit-fail">CRITICAL FAIL!</span>
            }
          </div>

          <p class="tier-description">{{ outcome.description }}</p>

          <!-- Collapsible Roll Details (for solo activities with detailed roll info) -->
          @if (data.summary.rollDetails) {
            @let rollDetails = data.summary.rollDetails;
            <mat-expansion-panel class="roll-details-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>casino</mat-icon>
                  Roll Details
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="roll-details">
                <div class="roll-item">
                  <span class="roll-label">2d100 Roll</span>
                  <span class="roll-value">{{ rollDetails.roll }}</span>
                </div>
                @if (rollDetails.statBonus !== undefined) {
                  <div class="roll-item">
                    <span class="roll-label">Stat Bonus</span>
                    <span class="roll-value positive">+{{ rollDetails.statBonus | number:'1.0-0' }}</span>
                  </div>
                }
                <div class="roll-item total">
                  <span class="roll-label">Total</span>
                  <span class="roll-value">{{ rollDetails.adjustedRoll | number:'1.0-0' }}</span>
                </div>
                <div class="roll-item">
                  <span class="roll-label">vs DC</span>
                  <span class="roll-value">{{ rollDetails.difficultyClass }}</span>
                </div>
              </div>

              <!-- Stat Contributions -->
              @if (hasStatContributions) {
                <mat-divider></mat-divider>
                <div class="stat-contributions-section">
                  <h4>Stats Used</h4>
                  <div class="stat-contributions">
                    @for (stat of statContributions; track stat.name) {
                      <div class="stat-contribution-item">
                        <mat-icon class="stat-icon">{{ stat.icon }}</mat-icon>
                        <span class="stat-name">{{ stat.name }}</span>
                        <span class="stat-value">{{ stat.value | number:'1.0-0' }}</span>
                      </div>
                    }
                  </div>
                  @if (rollDetails.statBonus !== undefined) {
                    <p class="stat-average">Average: {{ rollDetails.statBonus | number:'1.0-0' }}</p>
                  }
                </div>
              }

              <!-- Difficulty Breakdown -->
              @if (hasDifficultyBreakdown) {
                <mat-divider></mat-divider>
                <div class="difficulty-breakdown-section">
                  <h4>Difficulty Breakdown</h4>
                  <div class="difficulty-modifiers">
                    @for (modifier of difficultyModifiers; track modifier.label) {
                      <div class="difficulty-modifier-item" [class.positive]="modifier.value > 0" [class.negative]="modifier.value < 0">
                        <span class="modifier-label">{{ modifier.label }}</span>
                        <span class="modifier-value">{{ modifier.value > 0 ? '+' : '' }}{{ modifier.value }}</span>
                        <span class="modifier-description">{{ modifier.description }}</span>
                      </div>
                    }
                  </div>

                  <!-- Individual Trait Contributions -->
                  @if (hasIndividualTraits) {
                    <div class="trait-contributions-section">
                      <h5>Individual Trait Contributions</h5>
                      <div class="trait-contributions">
                        @for (trait of individualTraitContributions; track trait.name) {
                          <div class="trait-contribution-item" [class.positive]="trait.bonus > 0" [class.negative]="trait.bonus < 0">
                            <mat-icon>grade</mat-icon>
                            <span class="trait-name">{{ trait.name }}</span>
                            <span class="trait-bonus">{{ trait.bonus > 0 ? '+' : '' }}{{ trait.bonus }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  @if (data.summary.difficultyBreakdown) {
                    <div class="final-difficulty">
                      <span class="final-label">Final DC:</span>
                      <span class="final-value">{{ data.summary.difficultyBreakdown.finalDifficulty }}</span>
                    </div>
                  }
                </div>
              }

              <mat-divider></mat-divider>

              <!-- Probability Breakdown -->
              <div class="probability-section">
                <h4>Outcome Probabilities</h4>
                <div class="probability-bars">
                  <div class="probability-item">
                    <span class="prob-label">Catastrophic</span>
                    <div class="prob-bar-container">
                      <div class="prob-bar catastrophic" [style.width.%]="outcomeProbabilities.catastrophic"></div>
                    </div>
                    <span class="prob-value">{{ outcomeProbabilities.catastrophic }}%</span>
                  </div>
                  <div class="probability-item">
                    <span class="prob-label">Mixed</span>
                    <div class="prob-bar-container">
                      <div class="prob-bar mixed" [style.width.%]="outcomeProbabilities.mixed"></div>
                    </div>
                    <span class="prob-value">{{ outcomeProbabilities.mixed }}%</span>
                  </div>
                  <div class="probability-item">
                    <span class="prob-label">Okay</span>
                    <div class="prob-bar-container">
                      <div class="prob-bar okay" [style.width.%]="outcomeProbabilities.okay"></div>
                    </div>
                    <span class="prob-value">{{ outcomeProbabilities.okay }}%</span>
                  </div>
                  <div class="probability-item">
                    <span class="prob-label">Best</span>
                    <div class="prob-bar-container">
                      <div class="prob-bar best" [style.width.%]="outcomeProbabilities.best"></div>
                    </div>
                    <span class="prob-value">{{ outcomeProbabilities.best }}%</span>
                  </div>
                </div>
                @if (rollDetails.statBonus !== undefined) {
                  <p class="probability-note">These probabilities are based on your current stat ({{ rollDetails.statBonus }}) and activity difficulty ({{ activityDifficulty }}).</p>
                }
              </div>
            </mat-expansion-panel>
          }
        </div>

        @if (hasStatChanges || hasRelationshipChanges) {
          <mat-divider></mat-divider>
        }
      }

      <!-- Relationship Changes Section (social activities) -->
      @if (isSocialActivity && hasRelationshipChanges) {
        @let relChanges = data.summary.relationshipChanges!;
        <div class="relationship-changes-section">
          <h3>Relationship Changes</h3>

          <!-- Relationship Axes -->
          <div class="relationship-axes">
            @for (axisChange of relationshipAxisChanges; track axisChange.axis) {
              <div class="relationship-axis-item" [class.positive]="axisChange.delta > 0" [class.negative]="axisChange.delta < 0">
                <mat-icon class="axis-icon">{{ axisChange.icon }}</mat-icon>
                <span class="axis-name">{{ axisChange.axis }}</span>
                <span class="axis-delta" [class.positive]="axisChange.delta > 0" [class.negative]="axisChange.delta < 0">
                  {{ axisChange.delta > 0 ? '+' : '' }}{{ axisChange.delta }}
                </span>
                <span class="axis-new-value">({{
                  axisChange.axis === 'Trust' ? relChanges.newValues.trust :
                  axisChange.axis === 'Affection' ? relChanges.newValues.affection :
                  relChanges.newValues.desire
                }})</span>
              </div>
            }
          </div>

          <!-- State Change -->
          @if (relChanges.stateChanged) {
            <div class="state-change">
              <mat-icon>upgrade</mat-icon>
              <span class="state-label">Relationship Status:</span>
              <span class="state-previous">{{ formatRelationshipState(relChanges.previousState!) }}</span>
              <mat-icon class="arrow">arrow_forward</mat-icon>
              <span class="state-new">{{ formatRelationshipState(relChanges.newState!) }}</span>
            </div>
          }
        </div>

        <mat-divider></mat-divider>
      }

      <!-- Emotion State Section (social activities) -->
      @if (isSocialActivity && data.summary.emotionalState) {
        @let emotionInfo = getEmotionInfo();
        @if (emotionInfo) {
          <div class="emotion-section">
            <h3>{{ data.summary.npc?.name }}'s Emotional State</h3>
            <div class="emotion-display">
              <mat-icon class="emotion-icon">{{ emotionInfo.icon }}</mat-icon>
              <span class="emotion-primary">{{ emotionInfo.emotion }}</span>
            </div>
          </div>

          <mat-divider></mat-divider>
        }
      }

      <!-- Trait Discovery Section (social activities) -->
      @if (isSocialActivity && data.summary.discoveredTrait) {
        @let trait = data.summary.discoveredTrait;
        <div class="trait-discovery-section" [class.new-trait]="trait.isNew">
          <div class="trait-header">
            <mat-icon>{{ trait.isNew ? 'new_releases' : 'lightbulb' }}</mat-icon>
            <h3>{{ trait.isNew ? 'Trait Discovered!' : 'Trait Observed' }}</h3>
          </div>
          <div class="trait-info">
            <span class="trait-name">{{ trait.traitName }}</span>
          </div>
          <p class="trait-description">{{ trait.traitDescription }}</p>
        </div>

        <mat-divider></mat-divider>
      }

      <!-- Stat Changes Section -->
      @if (hasStatChanges) {
        <div class="stat-changes-section">
          <h3>Stat Changes</h3>

          <!-- Positive Changes -->
          @if (positiveChanges.length > 0) {
            <div class="stat-changes positive">
              @for (change of positiveChanges; track change.stat) {
                <div class="stat-change-item">
                  <mat-icon class="stat-icon">{{ getStatIcon(change.stat) }}</mat-icon>
                  <span class="stat-name">{{ formatStatName(change.stat) }}</span>
                  <span class="stat-delta positive">+{{ change.currentDelta | number:'1.1-1' }}</span>
                  <span class="stat-new-value">({{ change.newCurrent | number:'1.0-0' }})</span>
                </div>
              }
            </div>
          }

          <!-- Negative Changes -->
          @if (negativeChanges.length > 0) {
            <div class="stat-changes negative">
              @for (change of negativeChanges; track change.stat) {
                <div class="stat-change-item">
                  <mat-icon class="stat-icon">{{ getStatIcon(change.stat) }}</mat-icon>
                  <span class="stat-name">{{ formatStatName(change.stat) }}</span>
                  <span class="stat-delta negative">{{ change.currentDelta | number:'1.1-1' }}</span>
                  <span class="stat-new-value">({{ change.newCurrent | number:'1.0-0' }})</span>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- No Roll Activities (leisure, etc.) -->
      @if (!hasOutcome && !hasStatChanges) {
        <div class="simple-result">
          <mat-icon>check_circle</mat-icon>
          <p>Activity completed successfully!</p>
        </div>
      }

      <!-- Resource Summary -->
      <div class="resource-summary">
        <div class="resource-item" [class.negative-outcome]="hasAdditionalEnergyCost">
          <mat-icon>bolt</mat-icon>
          <span>{{ actualEnergyCost > 0 ? '+' : '' }}{{ actualEnergyCost }} Energy</span>
          @if (hasAdditionalEnergyCost) {
            <span class="additional-cost">({{ actualEnergyCost - data.summary.activity.energyCost }} extra)</span>
          }
        </div>
        @if (actualMoneyCost !== 0) {
          <div class="resource-item" [class.negative-outcome]="hasAdditionalMoneyCost">
            <mat-icon>payments</mat-icon>
            <span>{{ actualMoneyCost > 0 ? '+' : '' }}${{ actualMoneyCost }}</span>
            @if (hasAdditionalMoneyCost) {
              <span class="additional-cost">(${{ actualMoneyCost - data.summary.activity.moneyCost }} extra)</span>
            }
          </div>
        }
        <div class="resource-item" [class.negative-outcome]="hasAdditionalTimeCost">
          <mat-icon>schedule</mat-icon>
          <span>{{ actualTimeCost }} min</span>
          @if (hasAdditionalTimeCost) {
            <span class="additional-cost">(+{{ actualTimeCost - data.summary.activity.timeCost }} min)</span>
          }
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-raised-button color="primary" (click)="onContinue()">
      <mat-icon>check</mat-icon>
      Continue
    </button>
  </mat-dialog-actions>
</div>
