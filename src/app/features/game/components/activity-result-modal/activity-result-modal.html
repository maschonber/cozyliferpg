<div class="activity-result-modal">
  <h2 mat-dialog-title>
    <mat-icon>{{ data.activity.category === 'work' ? 'work' :
                 data.activity.category === 'social' ? 'groups' :
                 data.activity.category === 'self_improvement' ? 'school' : 'local_activity' }}</mat-icon>
    {{ data.activity.name }}
  </h2>

  <mat-dialog-content>
    <div class="result-content">
      <!-- Outcome Section (for activities with rolls) -->
      @if (hasOutcome) {
        @let outcome = data.result.outcome!;
        @let tierInfo = getTierInfo(outcome.tier);

        <div class="outcome-section" [style.--tier-color]="tierInfo.color">
          <div class="tier-badge">
            <mat-icon [style.color]="tierInfo.color">{{ tierInfo.icon }}</mat-icon>
            <span class="tier-label">{{ tierInfo.label }}</span>
            @if (isCritSuccess) {
              <span class="crit-indicator crit-success">CRITICAL SUCCESS!</span>
            }
            @if (isCritFail) {
              <span class="crit-indicator crit-fail">CRITICAL FAIL!</span>
            }
          </div>

          <p class="tier-description">{{ tierInfo.description }}</p>

          <!-- Collapsible Roll Details -->
          <mat-expansion-panel class="roll-details-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>casino</mat-icon>
                Roll Details
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="roll-details">
              <div class="roll-item">
                <span class="roll-label">2d100 Roll</span>
                <span class="roll-value">{{ outcome.roll }}</span>
              </div>
              <div class="roll-item">
                <span class="roll-label">Stat Bonus</span>
                <span class="roll-value positive">+{{ outcome.statBonus | number:'1.0-0' }}</span>
              </div>
              <div class="roll-item total">
                <span class="roll-label">Total</span>
                <span class="roll-value">{{ outcome.adjustedRoll | number:'1.0-0' }}</span>
              </div>
              <div class="roll-item">
                <span class="roll-label">vs DC</span>
                <span class="roll-value">{{ dc }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Probability Breakdown -->
            <div class="probability-section">
              <h4>Outcome Probabilities</h4>
              <div class="probability-bars">
                <div class="probability-item">
                  <span class="prob-label">Catastrophic</span>
                  <div class="prob-bar-container">
                    <div class="prob-bar catastrophic" [style.width.%]="outcomeProbabilities.catastrophic"></div>
                  </div>
                  <span class="prob-value">{{ outcomeProbabilities.catastrophic }}%</span>
                </div>
                <div class="probability-item">
                  <span class="prob-label">Mixed</span>
                  <div class="prob-bar-container">
                    <div class="prob-bar mixed" [style.width.%]="outcomeProbabilities.mixed"></div>
                  </div>
                  <span class="prob-value">{{ outcomeProbabilities.mixed }}%</span>
                </div>
                <div class="probability-item">
                  <span class="prob-label">Okay</span>
                  <div class="prob-bar-container">
                    <div class="prob-bar okay" [style.width.%]="outcomeProbabilities.okay"></div>
                  </div>
                  <span class="prob-value">{{ outcomeProbabilities.okay }}%</span>
                </div>
                <div class="probability-item">
                  <span class="prob-label">Best</span>
                  <div class="prob-bar-container">
                    <div class="prob-bar best" [style.width.%]="outcomeProbabilities.best"></div>
                  </div>
                  <span class="prob-value">{{ outcomeProbabilities.best }}%</span>
                </div>
              </div>
              <p class="probability-note">These probabilities are based on your current stat ({{ outcome.statBonus }}) and activity difficulty ({{ data.activity.difficulty }}).</p>
            </div>
          </mat-expansion-panel>
        </div>

        @if (hasStatChanges) {
          <mat-divider></mat-divider>
        }
      }

      <!-- Stat Changes Section -->
      @if (hasStatChanges) {
        <div class="stat-changes-section">
          <h3>Stat Changes</h3>

          <!-- Positive Changes -->
          @if (positiveChanges.length > 0) {
            <div class="stat-changes positive">
              @for (change of positiveChanges; track change.stat) {
                <div class="stat-change-item">
                  <mat-icon class="stat-icon">{{ getStatIcon(change.stat) }}</mat-icon>
                  <span class="stat-name">{{ formatStatName(change.stat) }}</span>
                  <span class="stat-delta positive">+{{ change.currentDelta | number:'1.1-1' }}</span>
                  <span class="stat-new-value">({{ change.newCurrent | number:'1.0-0' }})</span>
                </div>
              }
            </div>
          }

          <!-- Negative Changes -->
          @if (negativeChanges.length > 0) {
            <div class="stat-changes negative">
              @for (change of negativeChanges; track change.stat) {
                <div class="stat-change-item">
                  <mat-icon class="stat-icon">{{ getStatIcon(change.stat) }}</mat-icon>
                  <span class="stat-name">{{ formatStatName(change.stat) }}</span>
                  <span class="stat-delta negative">{{ change.currentDelta | number:'1.1-1' }}</span>
                  <span class="stat-new-value">({{ change.newCurrent | number:'1.0-0' }})</span>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- No Roll Activities (leisure, etc.) -->
      @if (!hasOutcome && !hasStatChanges) {
        <div class="simple-result">
          <mat-icon>check_circle</mat-icon>
          <p>Activity completed successfully!</p>
        </div>
      }

      <!-- Resource Summary -->
      <div class="resource-summary">
        <div class="resource-item" [class.negative-outcome]="hasAdditionalEnergyCost">
          <mat-icon>bolt</mat-icon>
          <span>{{ actualEnergyCost > 0 ? '+' : '' }}{{ actualEnergyCost }} Energy</span>
          @if (hasAdditionalEnergyCost) {
            <span class="additional-cost">({{ actualEnergyCost - data.activity.energyCost }} extra)</span>
          }
        </div>
        @if (actualMoneyCost !== 0) {
          <div class="resource-item" [class.negative-outcome]="hasAdditionalMoneyCost">
            <mat-icon>payments</mat-icon>
            <span>{{ actualMoneyCost > 0 ? '+' : '' }}${{ actualMoneyCost }}</span>
            @if (hasAdditionalMoneyCost) {
              <span class="additional-cost">(${{ actualMoneyCost - data.activity.moneyCost }} extra)</span>
            }
          </div>
        }
        <div class="resource-item" [class.negative-outcome]="hasAdditionalTimeCost">
          <mat-icon>schedule</mat-icon>
          <span>{{ actualTimeCost }} min</span>
          @if (hasAdditionalTimeCost) {
            <span class="additional-cost">(+{{ actualTimeCost - data.activity.timeCost }} min)</span>
          }
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-raised-button color="primary" (click)="onContinue()">
      <mat-icon>check</mat-icon>
      Continue
    </button>
  </mat-dialog-actions>
</div>
