<div class="neighbor-detail">
  <!-- Back Button and Actions -->
  <div class="back-button-container">
    <button mat-button (click)="onBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Neighbors
    </button>
    @if (selectedPlayerNPC()) {
      <button
        mat-button
        color="warn"
        (click)="onDeleteNPC()"
        [disabled]="isLoading()">
        <mat-icon>delete</mat-icon>
        Delete Character
      </button>
    }
  </div>

  <!-- Loading State -->
  @if (isLoading() && !selectedPlayerNPC()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading neighbor details...</p>
    </div>
  }

  <!-- Error State -->
  @if (!isLoading() && !selectedPlayerNPC()) {
    <div class="error-container">
      <mat-icon color="warn">error_outline</mat-icon>
      <p>Could not load neighbor details</p>
      <button mat-raised-button color="primary" (click)="onBack()">
        Return to Neighbors
      </button>
    </div>
  }

  <!-- Content - PlayerNPCView contains both NPC and relationship data -->
  @if (selectedPlayerNPC(); as playerNPC) {
    <div class="content">
      <!-- NPC Card -->
      <mat-card class="npc-card">
        <!-- Placeholder for future AI-generated image -->
        <div class="npc-image-placeholder">
          <mat-icon>person</mat-icon>
        </div>

        <mat-card-header>
          <mat-card-title>
            {{ playerNPC.name }}
            <span class="gender-badge" [class.gender-female]="playerNPC.gender === 'female'"
                  [class.gender-male]="playerNPC.gender === 'male'"
                  [class.gender-other]="playerNPC.gender === 'other'">
              @if (playerNPC.gender === 'female') {
                <mat-icon>female</mat-icon>
              } @else if (playerNPC.gender === 'male') {
                <mat-icon>male</mat-icon>
              } @else {
                <mat-icon>transgender</mat-icon>
              }
            </span>
          </mat-card-title>
        </mat-card-header>

        <!-- Current Emotion Display (Plutchik) -->
        @if (npcEmotion()) {
          <app-emotion-display [emotion]="npcEmotion()" />
        }

        <mat-card-content>
          <!-- Appearance -->
          <div class="section">
            <h3>Appearance</h3>
            <p class="appearance-text">{{ formatAppearance() }}</p>
            <p class="style-text">Style: {{ playerNPC.appearance.style }}</p>
          </div>

          <mat-divider></mat-divider>

          <!-- Traits -->
          <div class="section traits-section">
            <h3>Known Traits
              @if (playerNPC.revealedTraits.length > 0) {
                <span class="trait-count">({{ playerNPC.revealedTraits.length }})</span>
              }
            </h3>

            @if (playerNPC.revealedTraits.length === 0) {
              <p class="no-traits">No traits discovered yet. Spend time together to learn more!</p>
            } @else {
              <div class="traits-grid">
                @for (trait of getRevealedTraits(); track trait) {
                  <mat-chip class="trait-chip">{{ formatTraitName(trait) }}</mat-chip>
                }
              </div>
            }

            <!-- Hidden traits indicator -->
            @if (hasHiddenTraits()) {
              <div class="hidden-traits-hint">
                <mat-icon>help_outline</mat-icon>
                <span>More traits to discover through interactions</span>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Relationship Card -->
      <mat-card class="relationship-card">
        <mat-card-header>
          <mat-card-title>Relationship</mat-card-title>
          <mat-card-subtitle>
            {{ getStateDisplayName(playerNPC.currentState) }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <!-- Trust -->
          <div class="relationship-metric">
            <div class="metric-header">
              <mat-icon color="primary">shield</mat-icon>
              <span class="metric-label">Trust</span>
              <span class="metric-value">{{ playerNPC.trust }}</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="getProgressValue(playerNPC.trust)"
              [color]="getProgressColor(playerNPC.trust)">
            </mat-progress-bar>
          </div>

          <!-- Affection -->
          <div class="relationship-metric">
            <div class="metric-header">
              <mat-icon color="primary">favorite</mat-icon>
              <span class="metric-label">Affection</span>
              <span class="metric-value">{{ playerNPC.affection }}</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="getProgressValue(playerNPC.affection)"
              [color]="getProgressColor(playerNPC.affection)">
            </mat-progress-bar>
          </div>

          <!-- Desire -->
          <div class="relationship-metric">
            <div class="metric-header">
              <mat-icon color="accent">whatshot</mat-icon>
              <span class="metric-label">Desire</span>
              <span class="metric-value">{{ playerNPC.desire }}</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="getProgressValue(playerNPC.desire)"
              [color]="getProgressColor(playerNPC.desire)">
            </mat-progress-bar>
          </div>

          <mat-divider></mat-divider>

          <!-- Activities -->
          <div class="activities-section">
            <h3>Spend Time Together</h3>

            @if (interactionError()) {
              <div class="error-message">
                <mat-icon color="warn">error</mat-icon>
                <span>{{ interactionError() }}</span>
              </div>
            }

            <div class="activities-grid">
              @for (activity of socialActivities(); track activity.id) {
                <app-activity-button
                  [activity]="activity"
                  [availability]="getActivityAvailability(activity.id)"
                  [disabled]="interacting()"
                  [effects]="getActivityEffects(activity)"
                  [variant]="getActivityVariant(activity)"
                  (activityClick)="onPerformActivity($event)">
                </app-activity-button>
              }
            </div>

            @if (interacting()) {
              <div class="interacting-indicator">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Interacting...</span>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>
